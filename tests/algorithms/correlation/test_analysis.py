from __future__ import annotations

import json
import pathlib

import numpy as np
import pytest

from dials.algorithms.correlation.analysis import CorrelationMatrix
from dials.command_line.correlation_matrix import phil_scope
from dials.util.multi_dataset_handling import (
    assign_unique_identifiers,
    parse_multiple_datasets,
)
from dials.util.options import ArgumentParser, reflections_and_experiments_from_files

data_1 = np.array(
    [
        [0.64694156, 0.75886937],
        [0.64215717, 0.75578227],
        [0.64194984, 0.76323263],
        [0.64695796, 0.75880985],
        [0.64802521, 0.75718655],
        [0.64201306, 0.76249935],
        [0.64505828, 0.76086828],
        [0.64580819, 0.75973004],
        [0.7756648, 0.62532301],
        [0.76777932, 0.62953013],
        [0.78075539, 0.6206117],
        [0.77817223, 0.62429683],
        [0.77704555, 0.62557372],
        [0.78150494, 0.62080502],
        [0.77741299, 0.62578779],
        [0.78464834, 0.61706304],
    ]
)

expected_1 = np.array([0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1])

data_2 = np.array(
    [
        [0.5597874, 0.65848203, 0.48867481],
        [0.54058939, 0.69528252, 0.46051994],
        [0.55638102, 0.67987417, 0.45651643],
        [0.53675996, 0.68673141, 0.4700678],
        [0.57257004, 0.68677115, 0.43754531],
        [0.53698945, 0.69327016, 0.47030923],
        [0.54235753, 0.70202112, 0.44759975],
        [0.58346344, 0.68572358, 0.42095159],
        [0.55316365, 0.69201693, 0.45291027],
        [0.59256556, 0.68029316, 0.41689273],
        [0.59573353, 0.67570373, 0.41526597],
        [0.52296788, 0.69462476, 0.48329581],
        [0.70944747, 0.41999774, 0.55807468],
        [0.71565165, 0.42771859, 0.53879606],
        [0.75727012, 0.39334089, 0.50788252],
        [0.69947934, 0.42248587, 0.56613296],
        [0.75319622, 0.39935804, 0.49755604],
        [0.75565046, 0.42982241, 0.45656924],
        [0.75997823, 0.42208478, 0.45654379],
        [0.61600822, 0.44859586, 0.54650747],
        [0.74439601, 0.41183088, 0.51530569],
        [0.69966183, 0.42982216, 0.5552047],
        [0.63768752, 0.45196738, 0.60070512],
        [0.65969094, 0.44425925, 0.58665079],
        [0.39425083, 0.57305243, 0.71344971],
        [0.36988362, 0.56544593, 0.72938055],
        [0.36246223, 0.58049677, 0.72120055],
        [0.3867163, 0.5416965, 0.72408217],
        [0.37455631, 0.57114005, 0.72610101],
        [0.37620088, 0.57915917, 0.71706291],
        [0.37631958, 0.59077252, 0.70253556],
        [0.37316306, 0.56264465, 0.72712504],
        [0.38522628, 0.57418996, 0.71650824],
        [0.4047591, 0.57879682, 0.70174398],
        [0.37276662, 0.5571598, 0.73558583],
        [0.38286002, 0.5680666, 0.71641522],
    ]
)

expected_2 = np.array(
    [
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
    ]
)

data_3 = np.array(
    [
        [8.55409961e-01, 8.50574879e-02, 1.00621103e-01],
        [8.87871557e-01, -8.74756262e-03, 6.06795122e-02],
        [8.73941649e-01, 2.31368392e-02, 3.52075897e-02],
        [9.37252544e-01, 1.61395939e-02, 7.93415700e-02],
        [7.80741441e-01, 3.10314338e-02, 4.74256853e-02],
        [8.09568147e-01, 2.93641502e-02, 4.35026196e-02],
        [9.08195053e-01, 2.74466708e-02, 5.89648277e-02],
        [9.38650605e-01, -1.00654655e-02, 7.00305782e-02],
        [7.43015349e-01, 5.14286050e-02, 5.06231625e-02],
        [8.82971067e-01, 9.47973336e-02, 1.11571062e-01],
        [9.03238688e-01, 2.58386748e-04, 7.01258413e-02],
        [3.43489570e-01, 2.80577914e-01, 8.60088965e-01],
        [3.69416670e-01, 2.98994120e-01, 8.25550923e-01],
        [3.25353242e-01, 2.65972638e-01, 8.93455051e-01],
        [3.16323298e-01, 2.64332309e-01, 8.73587910e-01],
        [3.13955283e-01, 2.63058278e-01, 8.88517391e-01],
        [3.14587016e-01, 2.65872335e-01, 8.84276179e-01],
        [3.51183722e-01, 2.95248570e-01, 7.53235754e-01],
        [3.20634877e-01, 2.67271185e-01, 8.78443899e-01],
        [3.21310654e-01, 2.60103118e-01, 8.47744886e-01],
        [3.15698583e-01, 2.62671539e-01, 8.95874649e-01],
        [3.24916493e-01, 2.69340468e-01, 8.83299027e-01],
        [3.18395269e-01, 2.69326664e-01, 8.88293199e-01],
        [3.14118828e-01, 2.68011827e-01, 8.89495416e-01],
        [2.98347094e-01, 2.64519315e-01, 8.52455080e-01],
        [2.98622160e-01, 2.57103762e-01, 8.99730623e-01],
        [3.34076631e-01, 2.83574370e-01, 7.89425906e-01],
        [2.78395669e-01, 2.59399409e-01, 5.97769279e-01],
        [2.84626613e-01, 2.47638927e-01, 5.87406276e-01],
        [3.05282452e-01, 2.61303319e-01, 8.92706426e-01],
        [2.93957380e-01, 2.52384472e-01, 8.86342980e-01],
        [3.73876898e-01, 2.66125166e-01, 2.71573046e-01],
        [3.06226671e-01, 2.59415257e-01, 8.93873850e-01],
        [3.07797811e-01, 2.66897468e-01, 8.90247152e-01],
        [3.14773085e-01, 2.70132478e-01, 8.51356734e-01],
        [3.29108792e-01, 2.75516758e-01, 8.70937876e-01],
        [3.81199265e-01, 2.89715054e-01, 6.73445808e-01],
        [3.06736736e-01, 2.64416753e-01, 8.93212123e-01],
        [3.07980139e-01, 2.64505601e-01, 8.85508239e-01],
        [3.36310160e-01, 2.07196598e-01, 1.91850113e-01],
        [3.87251136e-01, 2.27085425e-01, 2.20198566e-01],
        [4.16624713e-01, 2.24015571e-01, 2.30158882e-01],
        [3.78133922e-01, 2.13316372e-01, 1.90338535e-01],
        [3.94157567e-01, 2.21242501e-01, 1.95222143e-01],
        [3.97666928e-01, 2.23469997e-01, 2.15915085e-01],
        [2.90166627e-01, 9.02257345e-01, 2.50340760e-02],
        [2.95054373e-01, 8.47199371e-01, -2.43582281e-02],
        [3.30505267e-01, 6.94727468e-01, 5.29886765e-02],
        [3.01074393e-01, 7.84934392e-01, -1.38835981e-02],
        [2.90957475e-01, 9.04996024e-01, 3.15459839e-02],
        [3.02220862e-01, 9.12580721e-01, 5.05571415e-02],
        [3.04511409e-01, 8.98629976e-01, 9.19694253e-03],
        [2.90666489e-01, 8.82046153e-01, -1.95152674e-02],
        [3.43192385e-01, 7.47853367e-01, 5.30695346e-02],
        [3.09417379e-01, 9.01904485e-01, -1.80701321e-04],
        [3.33117691e-01, 8.74712544e-01, 9.27584929e-03],
        [3.15667480e-01, 8.68723527e-01, -2.80249487e-02],
        [3.51409238e-01, 7.58295480e-01, 1.19397718e-01],
        [3.59378640e-01, 7.89033704e-01, 8.79225616e-02],
        [2.89172877e-01, 6.87196189e-01, -8.56112042e-03],
    ]
)

expected_3 = np.array(
    [
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        1,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        1,
        1,
        1,
        1,
        1,
        1,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
        3,
    ]
)

data_4 = np.array(
    [
        [
            0.4950104170640275,
            0.43743121129890083,
            0.5215487683123783,
            0.5120207049564419,
        ],
        [0.5136310154962787, 0.500116975102647, 0.4539888972344298, 0.5053641757883561],
        [
            0.48083448998843864,
            0.44380555269586847,
            0.5531484325031307,
            0.4894390884222043,
        ],
        [
            0.49560751462601965,
            0.47844142451767824,
            0.49218552691928036,
            0.5221634431394441,
        ],
        [
            0.5074571686556532,
            0.49647967971366047,
            0.44906037376229624,
            0.5247773257459739,
        ],
        [
            0.498918003252099,
            0.4934156315198896,
            0.46465975377644875,
            0.5258588201376331,
        ],
        [
            0.4974119802532667,
            0.4633979861680127,
            0.4982732130733742,
            0.5286453239065054,
        ],
        [
            0.44688060554136216,
            0.45629930947315905,
            0.43077690518879497,
            0.5057629390744536,
        ],
        [
            0.4963214840766464,
            0.477277176201595,
            0.49580922682859097,
            0.5182975386021194,
        ],
        [
            0.4897738352655084,
            0.4679082656745857,
            0.4997335627702349,
            0.5291741237095163,
        ],
        [
            0.5088743035633603,
            0.49788493835526304,
            0.45549570804380135,
            0.5209803551983379,
        ],
        [
            0.5183664086789908,
            0.5546930408006867,
            0.37858266396784745,
            0.49142944973442904,
        ],
        [
            0.4784348672378432,
            0.47683983087720155,
            0.4948303936272105,
            0.4852352632602574,
        ],
        [
            0.4882581600770309,
            0.4744117958199474,
            0.4983879230352882,
            0.5171743850831239,
        ],
        [
            0.4913064742817889,
            0.4547481965585937,
            0.5233292533670707,
            0.5161305073071873,
        ],
        [
            0.48951862238593913,
            0.45336160706537537,
            0.5171672460211949,
            0.5179320910959015,
        ],
        [
            0.4915142259297685,
            0.47543256732785033,
            0.5046618834549029,
            0.5136620110527477,
        ],
        [
            0.4873375881480605,
            0.4662801888785416,
            0.5135932887262284,
            0.5186477054786234,
        ],
        [0.4886203895418727, 0.4671056327038113, 0.5157357349317435, 0.513448094956109],
        [0.4891762251537515, 0.4634199328537888, 0.5148507317435983, 0.51274114296823],
        [
            0.4863539784576691,
            0.48375510313163084,
            0.5025719864690233,
            0.5088672120352546,
        ],
        [
            0.4881151103081683,
            0.4701190093987647,
            0.5108491982606843,
            0.5167456908184526,
        ],
        [
            0.5592549076250835,
            0.6209352642612234,
            0.16446431998452088,
            0.4685088400961323,
        ],
        [
            0.4857261704796991,
            0.4721791253229138,
            0.5130930069720766,
            0.5141274121226215,
        ],
        [
            0.4813884517546596,
            0.4995794010978498,
            0.35344977979719666,
            0.5188601208298014,
        ],
        [
            0.49042994836407755,
            0.46849173110398373,
            0.5021321067175679,
            0.5246553091397285,
        ],
        [
            0.4812040578827982,
            0.5067059930810859,
            0.4363540051773468,
            0.5133131365829742,
        ],
        [
            0.5242370966349548,
            0.5465036268550354,
            0.31626530537129227,
            0.4998654665253137,
        ],
        [
            0.4867315058267451,
            0.5246537167190932,
            0.4067384249968243,
            0.5071248285809654,
        ],
        [
            0.5048984033704094,
            0.5122705176371705,
            0.4242469096076748,
            0.5273049878519649,
        ],
        [
            0.46858759082908513,
            0.4616405712860905,
            0.38780161508820166,
            0.5191502774791996,
        ],
        [
            0.48968577824941967,
            0.4735515775294352,
            0.4959866933490791,
            0.5229350926720582,
        ],
        [
            0.4596775961301905,
            0.5121082439166583,
            0.4630692654935234,
            0.4769925162108157,
        ],
        [
            0.499362642983655,
            0.48919239539149645,
            0.4720089407961727,
            0.5175210786686717,
        ],
        [
            0.49495820837599225,
            0.4757326232309165,
            0.49335597474021037,
            0.523299431269177,
        ],
        [
            0.5025731882258606,
            0.49094314236418396,
            0.451347657957611,
            0.5338176621021413,
        ],
        [
            0.5424266454009758,
            0.5628673790405666,
            0.32290960977485605,
            0.4993364083473869,
        ],
        [
            0.5014702667550138,
            0.46395284417937266,
            0.4952322186765333,
            0.5148565413874187,
        ],
        [
            0.4960527188527438,
            0.4646329906629019,
            0.49312972307769026,
            0.5161514965928289,
        ],
        [
            0.5015971110702122,
            0.46496485665133547,
            0.4970489691333661,
            0.5151440671344916,
        ],
        [
            0.4930934118486947,
            0.4520026607000662,
            0.4972943165014865,
            0.5236855657369099,
        ],
        [
            0.47942063666315443,
            0.47410934032982943,
            0.5099672056482979,
            0.5015240606266668,
        ],
        [
            0.4934110168104628,
            0.47097943873434356,
            0.4866235862095897,
            0.530190924159539,
        ],
        [
            0.4986906785030024,
            0.48085368912769294,
            0.4728539575119441,
            0.5282395237873798,
        ],
        [
            0.4932773644779993,
            0.47854514792224084,
            0.517434029648383,
            0.4947997945318409,
        ],
        [
            0.5005394120121376,
            0.47800774903720084,
            0.4944951412282529,
            0.5136911478869721,
        ],
        [
            0.49157492740548264,
            0.4814895028711241,
            0.4964931057872945,
            0.5086518194071937,
        ],
        [0.5121342215734166, 0.5410082464618755, 0.3749926990657574, 0.513760649657932],
        [
            0.4925427930159888,
            0.46942564503877776,
            0.5082394120981522,
            0.5172079065245484,
        ],
        [
            0.4981182017510156,
            0.4562214244790894,
            0.5180857460015217,
            0.5146794335335654,
        ],
        [
            0.4955536139842687,
            0.45718950315894036,
            0.527014599880842,
            0.5055219769583489,
        ],
        [
            0.49653458842909687,
            0.4837454944397393,
            0.4635001203805373,
            0.5236470516685052,
        ],
        [0.504090715415989, 0.4690395800314123, 0.5051217055952607, 0.5083503811803208],
        [
            0.5009263639543354,
            0.47432069519181386,
            0.49545837071500864,
            0.5155945935531634,
        ],
        [
            0.5089559880575785,
            0.48189965309309757,
            0.476745121828652,
            0.5160717375952901,
        ],
        [
            0.4997649096486651,
            0.46183692265840953,
            0.5181537154003478,
            0.5097660231266207,
        ],
        [0.4989547868808424, 0.46352067748559156, 0.514882562919311, 0.512266097837384],
        [0.5102169509747989, 0.4926853076353052, 0.4603155940300915, 0.519822903361405],
        [
            0.49005217323587436,
            0.48991270588626556,
            0.46596249701858306,
            0.5128630977989488,
        ],
        [
            0.5120021548362883,
            0.4868934165905288,
            0.4693463256811126,
            0.5192672800077319,
        ],
        [
            0.48480351605682487,
            0.4549273174325235,
            0.5356088176515152,
            0.5095778116543163,
        ],
        [
            0.4861467270252796,
            0.44754412003216526,
            0.5309511035171007,
            0.5195705496424872,
        ],
        [
            0.4886794367749501,
            0.4551535917436893,
            0.5300970542519263,
            0.5111847223325233,
        ],
        [
            0.4911626157618687,
            0.45450684920791595,
            0.5189814197216397,
            0.5160667739925763,
        ],
        [
            0.4902458885865284,
            0.45213521659653944,
            0.5279175435518864,
            0.5150278376897375,
        ],
        [
            0.4937012671976055,
            0.46489967755752964,
            0.5160923547780747,
            0.5102991645539539,
        ],
        [
            0.49018339714037146,
            0.4258123346372935,
            0.5554408474745701,
            0.5079206075053468,
        ],
        [
            0.4858142197177862,
            0.4524445274830794,
            0.5293129544181592,
            0.5179009358661743,
        ],
        [0.4912714498089931, 0.46584256026743537, 0.508994026121346, 0.516998192325256],
        [
            0.4841413377843214,
            0.4616899342701328,
            0.5352068848234075,
            0.49685104807273484,
        ],
        [
            0.48086358788089206,
            0.4453403265604064,
            0.5614563205072529,
            0.48572667284011345,
        ],
        [
            0.4936109123317527,
            0.4680252823087309,
            0.5074349999725493,
            0.5165650508034134,
        ],
        [
            0.5005955151161482,
            0.46240606734278594,
            0.5096612279437368,
            0.5177509595979826,
        ],
        [0.4993771458776743, 0.4649695400565526, 0.514942547293925, 0.5077874161331044],
        [
            0.4913597472786688,
            0.46396904309190157,
            0.5225194285797876,
            0.5055071016001572,
        ],
        [
            0.48883879371748806,
            0.4578427228325632,
            0.5196712999795589,
            0.5204480633762469,
        ],
        [
            0.49515620715003394,
            0.47969713270708225,
            0.46870712680065735,
            0.5327561123606417,
        ],
        [
            0.531772367263768,
            0.5535797153143583,
            0.34269483505747206,
            0.5109814500434836,
        ],
        [
            0.4916799485221973,
            0.4728311432044222,
            0.5035371086277637,
            0.5117927872191358,
        ],
        [
            0.4966647956568585,
            0.4671187363746538,
            0.49898213572532946,
            0.5232278342191895,
        ],
        [
            0.48893071667762245,
            0.4535231997539962,
            0.532019554813271,
            0.5114823158484244,
        ],
        [
            0.48191189697084724,
            0.4706141434624268,
            0.4183359535446209,
            0.5377508244888437,
        ],
        [
            0.5010487812763145,
            0.47198673059992524,
            0.4903734933192867,
            0.5226711645877425,
        ],
        [
            0.49442354617611595,
            0.4754084820891156,
            0.4933155649629988,
            0.5181210760796303,
        ],
        [
            0.4143259030812194,
            0.45856781471036806,
            0.4613063916129591,
            0.4597927371734684,
        ],
        [
            0.4963531913072984,
            0.484213270228233,
            0.48304932216802576,
            0.5213760309603509,
        ],
        [
            0.48605995352008907,
            0.45826694035010607,
            0.5254482907078875,
            0.5192134755460268,
        ],
        [0.5037341396546957, 0.4756992000493368, 0.4506023672644146, 0.537366387305066],
        [
            0.49812965568725837,
            0.4506002854756229,
            0.5188952228170635,
            0.5163137617381892,
        ],
        [
            0.4943147798545896,
            0.46360974851778153,
            0.5055708475558204,
            0.5197688282443058,
        ],
        [0.5019788765440766, 0.487803220983081, 0.4834504152909396, 0.5135973210981494],
        [
            0.4446954785054027,
            0.44494430903625226,
            0.354868966740387,
            0.5075026523708009,
        ],
        [
            0.49568393585127896,
            0.4699486708623066,
            0.49838704929491506,
            0.517843662820431,
        ],
        [0.499040790284107, 0.4513358630246506, 0.5080885728264649, 0.5198050248054765],
        [0.4949225863570361, 0.4672414387571947, 0.5185107675205853, 0.50310871939697],
        [
            0.48546804345414135,
            0.44309442675704863,
            0.5461895252553293,
            0.5100291727814867,
        ],
        [
            0.48729357950316937,
            0.4470105925007063,
            0.5351783050954996,
            0.5165537992877475,
        ],
        [
            0.4857526930675995,
            0.4413895189842174,
            0.5475972428121633,
            0.5092167197890398,
        ],
        [
            0.38791254068323977,
            0.5874589161796545,
            0.4144083447838631,
            0.5004867261713092,
        ],
        [
            0.31222554171706546,
            0.5552421703795546,
            0.5642514469296827,
            0.5019852192719283,
        ],
        [
            0.3797213308465967,
            0.6044397042569437,
            0.4502883554243111,
            0.4929856234976791,
        ],
        [0.3639539258211143, 0.615928770874136, 0.4611520258916738, 0.5144369494897006],
        [
            0.3544892056931339,
            0.5878910553191663,
            0.5155902743785438,
            0.5035355336385655,
        ],
        [
            0.35928400785441533,
            0.5961145565163528,
            0.5172260421491804,
            0.49061682302704507,
        ],
        [
            0.35035285905888275,
            0.5846291422168959,
            0.5217542976105829,
            0.5048411293454891,
        ],
        [
            0.3574620699243213,
            0.5945625795719317,
            0.5153250002587161,
            0.49575878301383214,
        ],
        [
            0.3608987524461568,
            0.5995258544339859,
            0.4991782695196529,
            0.5010627734027863,
        ],
        [0.36166948014321454, 0.599186455066441, 0.501098130568675, 0.5008905382289669],
        [
            0.35959633862016904,
            0.609345340272717,
            0.48127563281336666,
            0.5047024207042972,
        ],
        [
            0.3515251962677696,
            0.5959000667017594,
            0.49883042374496045,
            0.5134494986715656,
        ],
        [
            0.3610540975399699,
            0.6110572617366878,
            0.47976403914763854,
            0.5077906797877079,
        ],
        [0.3544290798812857, 0.605572899261631, 0.4883146551339605, 0.5056540848690385],
        [
            0.36045954416262416,
            0.6075210206428093,
            0.4860077360154148,
            0.5061235504824054,
        ],
        [
            0.38011395900075523,
            0.6068157435190704,
            0.481946073238689,
            0.4861142887308496,
        ],
        [
            0.3775307910119117,
            0.6129581825572905,
            0.4704388185725789,
            0.4937313814755522,
        ],
        [
            0.3703564752371521,
            0.6070051411239363,
            0.47322999731231075,
            0.503403997500012,
        ],
        [
            0.34555352725138533,
            0.5942613770227088,
            0.49919527507746114,
            0.5163143212159657,
        ],
        [
            0.36503643418772336,
            0.597731046387041,
            0.4937212513826053,
            0.49917356330684476,
        ],
        [
            0.34655326495788963,
            0.5950573370340498,
            0.5098741680105143,
            0.507769275772119,
        ],
        [0.3590368829628329, 0.590896759723345, 0.4947287294676166, 0.508859147229627],
        [
            0.35824548959355723,
            0.6083847843060793,
            0.4744219816122079,
            0.5155593098812229,
        ],
        [
            0.3632572920241724,
            0.6117880610983581,
            0.4782320589271924,
            0.5055242270870859,
        ],
        [
            0.3587621712778491,
            0.6137734450297234,
            0.47604262806788133,
            0.5101702845521578,
        ],
        [0.3649318526371518, 0.5966595252662431, 0.49112855646628306, 0.50124692213107],
        [
            0.34882299553596186,
            0.5969773385838482,
            0.5131024570051561,
            0.5017948232997098,
        ],
        [
            0.35392837244747793,
            0.606054711804859,
            0.4950615493135279,
            0.5043654843512002,
        ],
        [0.5526456201174759, 0.462163355231028, 0.5032229360686413, 0.4552264225107506],
        [
            0.5388062235212162,
            0.4671336471617741,
            0.5328723250336549,
            0.4385885605353599,
        ],
        [
            0.5484569582506026,
            0.4468908197964113,
            0.5270153512767131,
            0.4616627623406849,
        ],
        [
            0.5534661971920739,
            0.4775869413366164,
            0.4982236841465933,
            0.45667052111186085,
        ],
        [
            0.5422036612451316,
            0.4774119906138556,
            0.5152663574130408,
            0.44128340335050426,
        ],
        [
            0.5538583410828768,
            0.4761484927470345,
            0.4946500274744985,
            0.45925875810251593,
        ],
        [
            0.5541006318777488,
            0.48898170180734973,
            0.4832296342184134,
            0.4591284416990021,
        ],
        [
            0.5382892149700497,
            0.44017794336604105,
            0.549739072424119,
            0.4559122496987146,
        ],
        [
            0.5469997316885808,
            0.46880176212467234,
            0.5117469076303712,
            0.4598739998158591,
        ],
        [
            0.5411565052988652,
            0.4499011564106046,
            0.5375478071881775,
            0.45707840098979324,
        ],
        [
            0.5406098966256995,
            0.4430903742102575,
            0.5445455275064741,
            0.45652806686471714,
        ],
        [
            0.5408013908022706,
            0.4589952849554771,
            0.5101282745923786,
            0.4706218185216688,
        ],
        [
            0.5398201550649767,
            0.4283955332841059,
            0.5524871895389375,
            0.4585053253980054,
        ],
        [
            0.5461804736801882,
            0.4557566291181595,
            0.532578580475193,
            0.45131760521537195,
        ],
        [
            0.5370964640828122,
            0.4530333468800632,
            0.5393011418781822,
            0.45720378303813064,
        ],
        [0.5494862931015849, 0.47472590535248, 0.4904064249892415, 0.4662863499481113],
        [
            0.5461618571255177,
            0.4752813132156038,
            0.510258237909828,
            0.44766236926472125,
        ],
        [
            0.5622755744433564,
            0.4871074978964254,
            0.4610106295920834,
            0.46174054497083644,
        ],
        [
            0.5604369104526241,
            0.4861751261521731,
            0.4824281560626044,
            0.45156576002142573,
        ],
        [
            0.5544794533960824,
            0.4873702302006792,
            0.4905751069638657,
            0.4507319161333129,
        ],
        [
            0.5496443840256876,
            0.47756247872065116,
            0.48090183935081965,
            0.4629420569275451,
        ],
        [
            0.5470317004690173,
            0.47494299436417403,
            0.5148488719104681,
            0.447365613262788,
        ],
        [
            0.5565757848338032,
            0.4800633178824654,
            0.48924070927885427,
            0.45837249497468235,
        ],
        [0.5207025435801129, 0.4755238006899545, 0.4499152563335552, 0.475737248315111],
        [
            0.5391550298550332,
            0.5066615945193624,
            0.41978225335255304,
            0.48055190142021853,
        ],
        [
            0.512125682635998,
            0.45748785347891024,
            0.4501270002415299,
            0.4989693574487175,
        ],
        [
            0.47229879978256956,
            0.4446233331781298,
            0.4481425289650582,
            0.4373684156818521,
        ],
        [
            0.5473203713788669,
            0.4828627260031579,
            0.48586497728573674,
            0.46260052413485236,
        ],
        [
            0.5379694856898446,
            0.47044074711717604,
            0.46918763669099134,
            0.4833565420718779,
        ],
        [
            0.5430776433865389,
            0.45870001409977423,
            0.533104176024846,
            0.45017447432883545,
        ],
        [0.540092258040073, 0.4721505460536622, 0.4787876359823526, 0.4667388676429212],
        [
            0.5422266819449524,
            0.45911406061023924,
            0.5313667192812502,
            0.45089829791800357,
        ],
        [
            0.5492367559736121,
            0.45127730877840483,
            0.5323021227879338,
            0.45047077526529017,
        ],
        [
            0.5399046631060295,
            0.44445246619369505,
            0.5540448112765981,
            0.43865815201337083,
        ],
        [
            0.5512384399377632,
            0.46246029676430367,
            0.5046107625764167,
            0.4569803600867878,
        ],
        [
            0.5481431286237458,
            0.4591021637055652,
            0.5296952320068394,
            0.44723651351207155,
        ],
        [
            0.5470250044503652,
            0.44653078541162033,
            0.5354182751370985,
            0.45467197688245964,
        ],
        [
            0.5468305272997934,
            0.4479600955928284,
            0.5388408324079613,
            0.4483813795045404,
        ],
        [
            0.5467531581726927,
            0.4567351760458132,
            0.5211890459311047,
            0.4598426070626263,
        ],
        [
            0.5455026476724347,
            0.4504802558823455,
            0.5373690646069287,
            0.4507295909431364,
        ],
        [
            0.5301980915896891,
            0.46836551594857634,
            0.5032671238174156,
            0.45645662983285806,
        ],
        [
            0.5426554233246232,
            0.4628260625387014,
            0.4553760876135413,
            0.48679354022819155,
        ],
        [
            0.5503125099007867,
            0.4749099132228062,
            0.4944903379669066,
            0.46466140037291515,
        ],
        [
            0.5341809018686723,
            0.479270018568859,
            0.4278396117068427,
            0.48637820769616574,
        ],
        [
            0.5333220922894573,
            0.4544591657919628,
            0.4570691637666902,
            0.48431462927230695,
        ],
        [
            0.5379656760720495,
            0.45986768609349576,
            0.5444454664540489,
            0.43305831891337765,
        ],
        [
            0.5518992526804521,
            0.46509740858760135,
            0.5060818928779438,
            0.45713067165712823,
        ],
        [
            0.5552364848965736,
            0.46913859516039264,
            0.5089061885627412,
            0.4505504910708335,
        ],
        [
            0.5522477376567778,
            0.4653912835504455,
            0.5107882543615007,
            0.4577593264474786,
        ],
        [
            0.5576820681633025,
            0.4844429274048534,
            0.49125083379329076,
            0.44677458072099224,
        ],
        [
            0.5538520854037761,
            0.46612597259402666,
            0.4952560189521254,
            0.46359672951283437,
        ],
        [0.555855601312603, 0.4667507509525387, 0.4964743755898445, 0.4626758010908608],
        [
            0.5457041688697352,
            0.46490816736995305,
            0.5174247918286095,
            0.4551004880077234,
        ],
        [0.542850986837064, 0.4476068996104966, 0.5182707641513985, 0.4697152609109624],
        [
            0.5385204268366723,
            0.44889523265917197,
            0.5337450824015992,
            0.4640421409841253,
        ],
        [
            0.5454531158483915,
            0.453479595651253,
            0.5242507871289305,
            0.45834624918241695,
        ],
        [
            0.5426898228857313,
            0.4385590338817281,
            0.5446203784340141,
            0.45617703209091126,
        ],
        [
            0.5441305113689157,
            0.44833738622312724,
            0.536895985419982,
            0.45067021521903183,
        ],
        [
            0.5481819081736656,
            0.45769586529719114,
            0.5158413885455818,
            0.459825329255999,
        ],
        [
            0.5433424887834186,
            0.43891710493809666,
            0.5437540013201488,
            0.45579769890411626,
        ],
        [
            0.5514210983564939,
            0.47358140683441996,
            0.49910400297138074,
            0.4607229924897208,
        ],
        [
            0.548098448649324,
            0.44917407375581614,
            0.540174819491173,
            0.44535052242968604,
        ],
        [
            0.542627661865043,
            0.43550420269290596,
            0.5518372233856235,
            0.44689295894476316,
        ],
        [0.5474615836893367, 0.447136838719503, 0.5389997588552887, 0.4492662543184132],
        [
            0.5525746893871772,
            0.4541740104409875,
            0.5202706710224534,
            0.4507951876016685,
        ],
        [0.5426671148422978, 0.4504110140160729, 0.53726934082002, 0.4547903499144855],
        [
            0.5462100188924013,
            0.44247932254653854,
            0.5428787536516385,
            0.4502071824355888,
        ],
        [0.544438525287159, 0.43772064692055235, 0.5466280946542027, 0.45234519903201],
        [
            0.5553151636175274,
            0.4697778183763442,
            0.4981088659605275,
            0.4491117798323285,
        ],
        [
            0.5467093899592835,
            0.4462491623473648,
            0.523617047263446,
            0.45628866401171825,
        ],
        [
            0.5568324642745259,
            0.4678192651271664,
            0.5113050972670992,
            0.44596974085661617,
        ],
        [
            0.5554975095750591,
            0.4663834145314451,
            0.5109694535011572,
            0.4498100808878235,
        ],
        [
            0.5574231200373881,
            0.46134197037241925,
            0.5123629506190531,
            0.452375910616712,
        ],
        [
            0.5543768777603557,
            0.4831081008951046,
            0.48961288876974296,
            0.4537544133002247,
        ],
        [
            0.5172929207937671,
            0.4625111669942251,
            0.5043090721985712,
            0.46477965179285285,
        ],
        [
            0.5508623150203046,
            0.46399146556129844,
            0.49448879662881096,
            0.47043436593800275,
        ],
        [
            0.5400376002310012,
            0.44309090256337025,
            0.5378298199296815,
            0.4637544582802276,
        ],
        [
            0.5504527341497178,
            0.4582213757413011,
            0.5117298455719204,
            0.46340486711875234,
        ],
        [
            0.5329661234209774,
            0.461781475556464,
            0.5170417682961942,
            0.45382145799370766,
        ],
        [
            0.5365426358579128,
            0.46889402382088824,
            0.5357548233626505,
            0.4304952642456535,
        ],
        [
            0.5442945103873332,
            0.4722272695039134,
            0.506950967047296,
            0.45717743940562133,
        ],
        [
            0.5402666291833462,
            0.45449070829623345,
            0.517856840307629,
            0.46180305870776195,
        ],
        [
            0.5237870932103503,
            0.4878043231883657,
            0.4841601730972941,
            0.45890559665604347,
        ],
        [
            0.538564613730761,
            0.46502168702131397,
            0.46325281465190216,
            0.47628398792981386,
        ],
        [
            0.5409830656069468,
            0.4788605815079801,
            0.4437815629089395,
            0.4833397562392229,
        ],
        [0.52493196673, 0.4601457374619539, 0.5363302816811794, 0.4446292720959526],
        [
            0.5212332612915936,
            0.4640071429795075,
            0.5035072892377939,
            0.46570054153210383,
        ],
        [
            0.5504494764717708,
            0.4790141510875972,
            0.4933042488696858,
            0.46558993922690345,
        ],
        [
            0.5369900297501141,
            0.4759121633071289,
            0.46044936946365594,
            0.49229888527590704,
        ],
    ]
)

expected_4 = np.array(
    [
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        -1,
        0,
        0,
        0,
        -1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        -1,
        0,
        -1,
        0,
        0,
        -1,
        -1,
        -1,
        -1,
        0,
        -1,
        0,
        0,
        0,
        -1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        -1,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        -1,
        0,
        0,
        0,
        -1,
        0,
        0,
        -1,
        0,
        0,
        0,
        0,
        0,
        0,
        -1,
        0,
        0,
        0,
        0,
        0,
        0,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        2,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        -1,
        -1,
        -1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        1,
        -1,
    ]
)


@pytest.fixture()
def proteinase_k(dials_data):
    mcp = dials_data("vmxi_proteinase_k_sweeps", pathlib=True)
    params = phil_scope.extract()
    input_data = []
    parser = ArgumentParser(
        usage=" ",
        phil=phil_scope,
        read_reflections=True,
        read_experiments=True,
        check_format=False,
        epilog=" ",
    )
    for i in [0, 1, 2, 3]:
        input_data.append(str(mcp / f"experiments_{i}.expt"))
        input_data.append(str(mcp / f"reflections_{i}.refl"))

    params, options, args = parser.parse_args(
        args=input_data, show_diff_phil=False, return_unhandled=True
    )

    params.output.json = "dials.correlation_matrix.json"

    reflections, experiments = reflections_and_experiments_from_files(
        params.input.reflections, params.input.experiments
    )

    reflections = parse_multiple_datasets(reflections)
    assert len(experiments) == len(reflections)
    assert len(experiments) > 1
    experiments, reflections = assign_unique_identifiers(experiments, reflections)
    yield experiments, reflections, params


def test_corr_mat(proteinase_k, run_in_tmp_path):
    experiments, reflections, params = proteinase_k
    matrices = CorrelationMatrix(experiments, reflections, params)
    matrices.calculate_matrices()
    matrices.output_json()
    assert pathlib.Path("dials.correlation_matrix.json").is_file()


def test_filtered_corr_mat(proteinase_k, run_in_tmp_path):
    experiments, reflections, params = proteinase_k
    ids_to_identifiers_map = {}
    for table in reflections:
        ids_to_identifiers_map.update(table.experiment_identifiers())

    # Simulate filtered dataset by multiplex
    id_to_remove = [ids_to_identifiers_map[2]]
    ids_to_identifiers_map.pop(2)
    reflections.pop(2)
    experiments.remove_on_experiment_identifiers(id_to_remove)

    matrices = CorrelationMatrix(
        experiments, reflections, params, ids_to_identifiers_map
    )
    matrices.calculate_matrices()
    matrices.output_json()
    assert pathlib.Path("dials.correlation_matrix.json").is_file()

    expected_ids = [[0, 3], [0, 1, 3]]

    # Check main algorithm correct with filtering
    for i, j in zip(matrices.correlation_clusters, expected_ids):
        assert i.labels == j

    # Check json output also correct
    with open(pathlib.Path("dials.correlation_matrix.json")) as f:
        data = json.load(f)

    assert len(data["correlation_matrix_clustering"]) == len(expected_ids)
    for i, j in zip(data["correlation_matrix_clustering"], expected_ids):
        assert len(data["correlation_matrix_clustering"][i]["datasets"]) == len(j)
        for a, e in zip(data["correlation_matrix_clustering"][i]["datasets"], j):
            assert a == ids_to_identifiers_map[e]


# Test for very clearcut cases
@pytest.mark.parametrize(
    "coordinates,expected_labels,initial_guess",
    [
        (data_1, expected_1, 4),
        (data_2, expected_2, 6),
        (data_3, expected_3, 8),
    ],
)
def test_optics_classification_definitive(coordinates, expected_labels, initial_guess):
    _, _, actual_labels, _ = CorrelationMatrix.minimise_DB_score(
        coordinates, initial_guess=initial_guess
    )

    assert np.array_equal(actual_labels, expected_labels)


# Test for more ambiguous datasets - set up to add more in future if needed
@pytest.mark.parametrize(
    "coordinates,expected_labels,initial_guess",
    [
        (data_4, expected_4, 27),
    ],
)
def test_optics_classification_variable(coordinates, expected_labels, initial_guess):
    _, _, actual_labels, _ = CorrelationMatrix.minimise_DB_score(
        coordinates, initial_guess=initial_guess
    )

    differences = actual_labels != expected_labels

    difference_indices = np.argwhere(differences)

    values = [
        (actual_labels[tuple(idx)], expected_labels[tuple(idx)])
        for idx in difference_indices
    ]

    noise_change_count = 0
    changed_classification = []

    # Expected as algorithms change that a small number of datasets may switch between noise/cluster
    for i in values:
        if i[0] == -1 or i[1] == -1:
            noise_change_count += 1
        else:
            changed_classification.append(i)

    assert noise_change_count < 6
    assert len(changed_classification) == 0
